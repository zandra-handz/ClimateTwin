<!DOCTYPE html>
<html lang="en">

{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClimateTwin API Demo</title>
    <meta property="og:title" content="ClimateTwin API Demo">
    <meta property="og:description" content="Page to trial key ClimateTwin endpoints and view an animation of the main search algorithm in real time.">
    <meta property="og:image" content="http://127.0.0.1:8000/climatevisitor/static/climatevisitor/demo_preview.png">
    <!-- <meta property="og:image" content="https://climatetwin-lzyyd.ondigitalocean.app/climatevisitor/static/climatevisitor/demo_preview.png"> -->

    <style>
        * {
            font-family: 'Poppins', Arial, sans-serif;
        }

        body {
            font-family: 'Poppins', sans-serif; 
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #f0f0f0;
        }


        .container {
            display: block;
            flex-direction: column;
            align-items: center;
            border-radius: 20px;
            max-width: 900px;  
            margin: 0 auto;  
            margin-top: 3px;
            margin-bottom: 20px;
            padding: 10px; 
        }
        
        .header {
            font-size: 20px;
            justify-content: center;
            width: 98%;
            margin: 0 auto;
            margin-top: 8px;
            margin-bottom: 0px;
        }

        .sections {
            display: flex;
            flex-wrap: wrap; /* Allow sections to wrap on smaller screens */
            justify-content: space-between;
            margin-bottom: 0px;  
        }

        .fixed-top-container {
            position: fixed;
            width: 100%;
            top: 0;  
            left: 50%;
            transform: translateX(-50%);
            display: block;
            flex-direction: column;
            align-items: center;
            border-radius: 0 0 20px 20px;
            max-width: 900px;
            margin: 0 auto; 
            padding: 0px;
            z-index: 2; 
            background-color: #f0f0f0;

        }


        .fixed-bottom-container {
            position: fixed;
            width: 100%;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: block;
            flex-direction: column;
            align-items: center;
            border-radius: 20px 20px 0 0;
            max-width: 900px;
            margin: 0 auto; 
            padding: 0px;
            z-index: 2;
            background-color: #f0f0f0;
        }


        .fixed-sections {
            width: 98%;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap; 

            justify-content: space-between;
            background-color: #f0f0f0;
        }

        .go-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            width: 98%;
            margin: 0 auto;
        }

        .section {
            width: calc(33.33% - 4px);  
            margin-bottom: 10px;  

        }

        .input-section {
            width: calc(87.5% - 4px); 
            margin-bottom: 10px;
        }

        .input-section input {
            width: 100%;
            font-size: 12px;
            padding: 3px 5px;
            border: 1px solid #ccc;
            height: 20px;
            border-radius: 10px;
            margin-right: 6px;
        }

        #addressForm {
            width: 100%;
            flex-wrap: wrap; 
            justify-content: space-between;     
        }


        .go-button-section {
            width: calc(12.5% - 8px); 
            margin-bottom: 10px;
        }

        .go-button-section .go-button {
            width: 100%;
            height: 100%;
            background-color: transparent; 
            border-radius: 6px;
            cursor: pointer;
            justify-content: center;
            align-items: center;
            border: none;
        }

        .go-button-section .go-button i {
            
            font-size: 20px; 
            color: #007bff;
            border: none;
        }

        .go-button-section button:hover {
            background-color: #0056b3;
            border-radius: 10%;
            padding: 2px;
            border: none;

        }

        .go-button-section button:focus {
            background-color: #0056b3;
            border-radius: 10%;
            padding: 2px;
            border: none;
        }

        .form-group {
            font-size: 11px;
            align-items: center;
            margin-bottom: 6px;
        }

        .form-group input {
            width: 100%;
            font-size: 12px;
            padding: 3px 5px;
            border: 1px solid #ccc;
            height: 24px;
            border-radius: 10px;
            margin-right: 1px; 
        }

        .form-group button {
            width: 100%;
            min-width: 70px;
            height: 26px;
            padding: 3px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            overflow: hidden; 
            white-space: nowrap; /* Prevent text from wrapping */
            text-overflow: ellipsis;
        }

        .form-group .go-button {
            width: 100%;
            height: 100%;
            /* background-color: transparent;  /* This line seems redundant */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            justify-content: center;
            align-items: center;
        }

        .form-group .go-button i {
            
            font-size: 20px;  
            margin-right: 5px;  
            color: #007bff;
        }

        .form-group button:hover {
            background-color: #0056b3;
            border-radius: 6px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .form-group button:focus {
            background-color: #0056b3;
            border-radius: 6px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        #giftFriendsRadio {
            width: 100px;
        }

        .radio-label {
            font-size: 12px; 

        }

        .radio-label input[type="radio"] {
            margin-right: 8px;
            margin-bottom: 7px;
            vertical-align: middle;
        }

        .result-container, .result-bottom-container {
            width: 98%;
            margin: 0 auto;
        }

        .one-third-of-websocket-container {
            flex: 0 0 33.33%; 
        }

        .two-thirds-of-websocket-container {
            flex-grow: 1; 
        }

        .websocket-container_old {
            display: flex;
            align-items: center;
            justify-content: center; 
            flex-direction: column; 
            flex-direction: row;
            min-height: 36px;
            height: auto;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px;
            padding-top: 2px;
            box-sizing: border-box;
            width: 98%;
            margin: 0 auto;
        }

        .websocket-container {
            display: flex;
            align-items: center; 
            justify-content: center;
            min-height: 36px;
            height: auto;
            width: 98%; 
            margin: 0 auto;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 1px;
            box-sizing: border-box;
        }

        .websocket-element-left {
            position: absolute;
            flex: 0 0 auto;         }

        .websocket-element-center {
            width: 40%;
            flex: 0 0 auto; 
            margin-left: auto; 
            margin-right: auto; 
        }

        .map-side-panel-container {
            display: flex;
            width: 30px;
        }

        .summary-text-container {
            margin-bottom: 10px;
            margin-top: 10px;
            padding: 12px;
            background-color: white;
            border: 1px solid #ccc;
            border: 1px solid white;
            border-radius: 10px;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 2;

        }


        .result, .result-bottom {
            margin-bottom: 10px;
            margin-top: 10px;
            padding: 12px;
            background-color: white;
            border: 1px solid #ccc;
            border: 1px solid white;
            border-radius: 10px;
            font-size: 11px;
            overflow: hidden; 
            text-overflow: ellipsis;
        }


        .result, .result-bottom {
            flex: 1;
            padding: 12px;
        }

        .box-result {
            margin-bottom: 10px;
            margin-top: 10px;
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 10px; 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Automatically adjust column width */
            grid-gap: 10px; /* Adjust the gap between grid items */
        }

        .square-container {
            width: 100%; 
            height: 160px;
            border: 1px solid white; 
            border-radius: 10px;
            font-size: 10px;
            padding: 8px; 
            box-sizing: border-box;  
            display: grid; /* Use grid layout */
            grid-template-columns: 1fr; /* One column */
            align-items: start; 
            grid-template-rows: 1fr 5fr; /* Two rows with heights in proportion */
            /* overflow: hidden;  Hide overflowing content */
        }


        
        /* Custom scrollbar */
        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 10px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .loading-container {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100%;
        }


        #map-container {
            display: none;
            position: relative;
            width:100%;
            height: 50vw;
            max-width: 1200px; /* Optionally limit maximum width */
            margin: 0 auto; /* Center the container */
            border-radius: 30%;
            overflow: hidden;
        }
        
        #map-canvas {
            width: 100%;
            height: 100%;
            max-height: 600px;
            background-image: url('{% static "climatevisitor/map4.png" %}');
            background-color: transparent;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 30%;
        }

        .dot {
            position: absolute;
            width: 6px; /* Increase dot size for better visibility */
            height: 6px; /* Increase dot size for better visibility */
            background-color: darkgreen;
            border-radius: 50%;
            transition: opacity 0.6s ease; /* Adjust the duration as needed */
            opacity: 1; /* Initial opacity set to 1 */
        }

        
        /* CSS for the pulsing effect */
        .current-dot {
            position: absolute;
            width: 6px; /* Increase dot size for better visibility */
            height: 6px; /* Increase dot size for better visibility */
            background-color: greenyellow;
            border-radius: 50%;
            animation: pulse 1s infinite alternate; /* Adjust the animation duration as needed */
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(1.1); /* Adjust the scale factor for the pulsing effect */
            }
        }




        .center-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red; /* or any other color you prefer */
            border-radius: 50%; /* to make it a circle */
            z-index: 1; /* ensure it's above other elements */
        }
        #start-animation {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          border-left-color: #007bff; /* Blue color */
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }

        .item-choice-key {
            word-wrap: break-word; 
            width: 100%;
            grid-row: 1; /* Place key paragraph in the first row */
            white-space: pre-wrap;
            overflow-wrap: break-word;
            height: 100%;
            align-self: start; /* Align the key text to the start (top) */
            justify-self: start; 
            margin-top: 0;
        }


        .treasure-button {
            background-color: limegreen;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
            margin: 0 auto;
            margin-bottom: 10px;
            grid-row: 2;
            width: 100%; 
            height: 100%;  
            word-wrap: break-word; 
            overflow-wrap: break-word;
            white-space: normal; 
        }

        .treasure-button:hover {
            background-color: darkgreen;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .explore-button {
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
        }

        .explore-button:hover {
            background-color: #0056b3;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .gift-button {
            background-color: orange;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
        }

        .gift-button:hover {
            background-color: darkorange;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .open-message-button {
            background-color: purple;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
        }

        .open-message-button:hover {
            background-color: indigo;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .open-message-button:focus {
            background-color: indigo;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .request-buttons-container {
            width: 34%;
            justify-content: space-between;
        }

        .accept-request-button {
            background-color: rgb(225, 41, 102);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
        }

        .accept-request-button:hover {
            background-color:  rgb(159, 13, 49);
            border: none;
        }

        .accept-request-button:focus {
            background-color:  rgb(159, 13, 49);
            border: none;
        }

        .reject-request-button {
            background-color: rgb(52, 163, 188);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
        }

        .reject-request-button:hover {
            background-color:rgb(8, 107, 129);
            border: none;
        }

        .reject-request-button:focus {
            background-color:rgb(8, 107, 129);
            border: none;
        }


        .popup-menu {
            /* Other styles... */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            width: 300px; /* Adjust width as needed */
        }

        .popup-menu-header {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
        }

        .popup-menu-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #777;
            margin: 0;
            top: 10px;
            right: 0;
            padding: 0;
        }

        .popup-menu-title {
            width: calc(100% - 20px); 
            font-size: 16px;
            margin-top: 6px;
        }

        .popup-menu form {
            display: flex;
            flex-direction: column;
        }

        .popup-menu input {
            width: calc(100% - 18px); 
            border-radius: 10px;
        }

        .popup-menu button {
            border-radius: 10px;
            width: 100%;
        }

        .popup-menu-close button {
            border-radius: 10px;
            width: auto;
            align-items: right;
            right: 0;

        }



        .popup-menu form .form-group textarea,
        .popup-content form .form-group textarea {
            width: calc(100% - 16px); 
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 10px;
            resize: vertical; 
        }

        .popup-menu-submit button {
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
            bottom: 10px;
        }

        .popup-menu-close button {
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: 400;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .popup-menu-submit button:hover,
        .popup-menu-close button:hover {
            background-color: #0056b3;
            border-radius: 10px;
            color: #fff;
        }








    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</head>
<body>
    <div class="fixed-top-container">
        <div class="header">ClimateTwin API Demo</div>
        
            
        <form id="addressForm">
            <div class="go-section">
                <div class="input-section">
                    <input type="text" id="address" name="address" placeholder="Enter address" required>
                </div>
                <div class="go-button-section">
                    <button class="go-button" type="submit">
                        <i class="fas fa-arrow-alt-circle-right"></i>  
                    </button>
                </div>
            </div>
        </form>
            
        <div class="fixed-sections">
            <div class="section">
                <div class="form-group">
                    <button id="homeWeatherBtn">Home</button>
                </div>
                <div class="form-group">
                    <button id="currentlyVisitingBtn">Twin</button>
                </div>
            </div>
            <div class="section">
                <div class="form-group">
                    <button id="currentlyNearbyBtn">Nearby</button>
                </div>
                <div class="form-group">
                    <button id="currentlyExploringBtn">Exploring</button>
                </div>
            </div>
            <div class="section">
                <div class="form-group">
                    <button id="itemChoicesBtn">Collect Treasure</button>
                </div>
                <div class="form-group">
                    <button id="viewTreasuresBtn">Treasures</button>
                </div>
            </div>
        </div>
        <div class="sections"></div>
            <div class="websocket-container">
                <div class="websocket-element-center">
                    <div id="map-container">
                        <canvas id="map-canvas"></canvas>
                    </div>
                </div>
                <div class="websocket-element-left">
                    <div id="climate-updates-container"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="sections">
            <div class="result-container scrollbar">
                <div id="result"></div>
            </div>
        </div>
    </div>
    <div class="fixed-bottom-container">
        <div class="fixed-sections">
            <div class="section">
                <div class="form-group">
                    <button id="userInboxBtn">Inbox</button>
                </div>
                <div class="form-group">
                    <button id="userSettingsBtn">Settings</button>
                </div>
            </div>
            <div class="section">
                <div class="form-group">
                    <button id="userProfileBtn">Profile</button>
                </div>
                <div class="form-group">
                    <button id="userFriendProfilesBtn">Friends</button>
                </div>
            </div>
            <div class="section">
            
                <div class="form-group">
                    <button id="userSummaryBtn">User Summary</button>
                </div>
                <div class="form-group">
                    <button id="userPerfDataBtn">Performance</button>
                </div>
            </div>
            </div>
        </div>

    </div>
    <div class="container">
        <div class="sections">
            <div class="result-bottom-container">
                <div id="result-bottom"></div>
            </div>
        </div>
    </div>


    <!-- Popup menu HTML -->
    <div class="popup-menu" id="popupMenu" style="display: none;">
        <div class="popup-menu-header">
            <h2 class="popup-menu-title">What did you find?</h2>
            <button class="popup-menu-close" id="popupCloseBtn">Close</button>
        </div>
        <form id="popupForm">
            <input type="hidden" id="itemInput" name="item">
            <div class="form-group">
                <input type="text" id="descriptorInput" name="descriptor" placeholder="Descriptor">
            </div>
            <div class="form-group">
                <textarea id="descriptionInput" name="description" placeholder="Description"></textarea>
            </div>
            <div class="form-group">
                <textarea id="thirdDataInput" name="third_data" placeholder="Additional Data"></textarea>

                <button class="popup-menu-submit" type="submit">Collect Treasure</button>
            </div>
        </form>
    </div>



    <div class="popup-menu" id="giftTreasurePopup" style="display: none;">
        <div class="popup-content">
            <div class="popup-menu-header">
                <h2 class="popup-menu-title">Send to a friend</h2>
                <button class="popup-menu-close" id="popupGiftCloseBtn">Close</button>
            </div>
            <form id="popupGiftForm">
                <input type="hidden" id="treasureIdInput" name="treasureId">
                    <div class="form-group">
                        <div id="giftFriendsRadio"></div>
                        </div>
                    <div class="form-group">
                    <textarea id="messageInput" name="message" placeholder="Enter your message"></textarea>
                    <button class="popup-menu-submit" type="submit">Send Gift</button>
                </div>
            </form>
        </div>
    </div>


    
    <script src="{% static 'climatevisitor/js/coordinatesloader.js' %}"></script>
    <script src="{% static 'climatevisitor/js/maploader.js' %}"></script>
    
    <script>
        var token = "f38e6b71380f11f62071126b0ff43fc0a2689982";
 

        (function() {
 

 

            //Digital Ocean
            //var token = "f38e6b71380f11f62071126b0ff43fc0a2689982";
            displayLoading('climate-updates-container', token);
            displayLocationUpdate('climate-updates-container', token);
        })();

    </script>
    

    <script>
        //local:
        var token = "f38e6b71380f11f62071126b0ff43fc0a2689982";
        var endpoint = "/climatevisitor/";
        var userEndpoint = "/users/";

      //  const token = "0f27cbcf2998d5141a52ef68caa315f187d2437f";

        // local: 

        //var token = "f38e6b71380f11f62071126b0ff43fc0a2689982";

        function makeGetRequest(url, callback) {
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Token ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                callback(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        
        function setScrollbarPosition() {
            var fixedTopContainer = document.querySelector('.fixed-top-container');
            var resultContainer = document.querySelector('.result-container');
            var fixedTopContainerHeight = fixedTopContainer.offsetHeight;
            resultContainer.style.paddingTop = fixedTopContainerHeight + 'px';
        }

        window.addEventListener('load', setScrollbarPosition);
        window.addEventListener('resize', setScrollbarPosition);

        function formatTreasures(data) {
            var resultContainer = document.getElementById('result');
            resultContainer.innerHTML = ''; 

            if (data.length > 0) {
                data.forEach(treasure => {
                    var div = document.createElement('div');
                    div.classList.add('result');
                    var keysToDisplay = ["id", "descriptor", "description", "add_data", "miles_traveled_to_collect", "item_name", "item_category", "owned_since", "pending", "original_user", "found_at_latitude", "found_at_longitude", "giver", "recipient", "message"];
                    keysToDisplay.forEach(key => {
                        if (key in treasure) {
                            // Create a paragraph element for each key-value pair
                            var paragraph = document.createElement('p');

                            // Format key as bold
                            var boldKey = document.createElement('strong');
                            boldKey.innerText = key + ': ';

                            // Append key-value pair to the paragraph
                            paragraph.appendChild(boldKey);
                            paragraph.appendChild(document.createTextNode(treasure[key]));

                            // Append the paragraph to the result container
                            div.appendChild(paragraph);
                        }
                    });

                    // Add a button for giving treasure to a friend
                    var giftButton = document.createElement('button');
                    giftButton.innerText = 'Give Treasure to a Friend';
                    giftButton.classList.add('gift-button');

                    // Set the treasure ID as a data attribute
                    giftButton.setAttribute('data-treasure-id', treasure.id);

                    // Add event listener to the gift button
                    giftButton.addEventListener('click', function() {
                        var treasureId = this.getAttribute('data-treasure-id');
                        getFriendsAndDisplayTreasurePopup(treasureId); // Corrected function call
                    });

                    // Append the button to the div
                    div.appendChild(giftButton);

                    // Append the div to the result container
                    resultContainer.appendChild(div);
                });
            } else {
                resultContainer.innerText = 'No treasures available.';
            }
        }


        // Function to handle explore button click
        function exploreLocation(locationId, locationType) {
            // Prepare data for the POST request
            var data = {};

            // Determine the type of location
            if (locationType === 'twin_location') {
                data.twin_location = locationId;
            } else if (locationType === 'discovery_location') {
                data.explore_location = locationId;
            } else {
                console.error('Invalid location type:', locationType);
                return;
            }

            // Make a POST request to the explore endpoint
            fetch(endpoint + 'explore/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Token ' + token
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                // Handle response as needed
                console.log(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }


        // Event listener for explore buttons (currently nearby)
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('explore-button')) {
                // Extract location ID from the button's data attribute
                var locationId = event.target.dataset.id;
                // Extract explore type from the button's data attribute
                var exploreType = event.target.dataset.exploreType;
                exploreLocation(locationId, exploreType);
            }
        });


/*
        // Function to display loading spinner and fetch socket data
        function displayLoading(resultContainerId) {
            var resultContainer = document.getElementById(resultContainerId);
            // Clear existing content
            resultContainer.innerHTML = '';
            // Create a div to contain the spinner
            var loadingDiv = document.createElement('div');
            loadingDiv.classList.add('loading-container');
            // Add the spinner inside the div
            loadingDiv.innerHTML = '<div class="spinner"></div>';
            // Append the loading div to the result container
            resultContainer.appendChild(loadingDiv);

            // WebSocket connection
            const socket = new WebSocket('ws://localhost:8000/ws/climate-twin/'); // Replace with your WebSocket URL

            // Event listener for WebSocket open
            socket.onopen = function(event) {
                console.log('WebSocket connection opened');
            };

            // Event listener for WebSocket messages
            socket.onmessage = function(event) {
                const update = JSON.parse(event.data);
                replaceUpdate(update); // Call replaceUpdate to display the socket output
            };

            // Event listener for WebSocket close
            socket.onclose = function(event) {
                console.log('WebSocket connection closed');
            };

            // Event listener for WebSocket errors
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // Function to append new update to the container
        function replaceUpdate(update) {
            const container = document.getElementById('climate-updates-container');
            const updateElement = document.createElement('div');
            updateElement.textContent = `Latitude: ${update.latitude}, Longitude: ${update.longitude}`;
            container.innerHTML = ''; // Clear the container's content
            container.appendChild(updateElement);
        }


*/


        // Function to display result in the specified result container
        function displayResult(resultContainerId, data) {
            var resultContainer = document.getElementById(resultContainerId);
            // Remove previous loading containers
            resultContainer.querySelectorAll('.loading-container').forEach(container => container.remove());
            resultContainer.innerHTML = ''; // Clear previous results

            // Check if data is a dictionary (object)
            if (typeof data === 'object' && data !== null && !Array.isArray(data)) {
                // Create a div for the single dictionary (currently-visiting response)
                var div = document.createElement('div');
                div.classList.add('result');

                // Iterate over the keys of the dictionary
                Object.keys(data).forEach(key => {
                    // Create a paragraph element for each key-value pair
                    var paragraph = document.createElement('p');

                    // Format key as bold
                    var boldKey = document.createElement('strong');
                    boldKey.innerText = key + ': ';

                    // Append key-value pair to the paragraph
                    paragraph.appendChild(boldKey);

                    // Check if the value is null for the specific key
                    if (data[key] === null) {
                        paragraph.appendChild(document.createTextNode("empty"));
                    } else if (typeof data[key] === 'object' && !Array.isArray(data[key])) {
                        // Recursively format the nested object
                        formatNestedObject(paragraph, data[key]);
                    } else {
                        paragraph.appendChild(document.createTextNode(data[key]));
                    }

     


                    // Append the paragraph to the result container
                    div.appendChild(paragraph);
                });

                // Append the div to the result container
                resultContainer.appendChild(div);
            } else if (Array.isArray(data)) {
                // If data is an array, display as usual (for currently-nearby response)
                if (data.length > 0) {
                    data.forEach((item, index) => {
                        // Create a div for each object
                        var div = document.createElement('div');
                        div.classList.add('result');

                        // Extract and format the desired keys for currently-nearby response
                        var keysToDisplay = ["id", "name", "explore_type", "direction", "miles_away", "wind_compass", "latitude", "longitude"];
                        keysToDisplay.forEach(key => {
                            if (key in item) {
                                // Create a paragraph element for each key-value pair
                                var paragraph = document.createElement('p');

                                // Format key as bold
                                var boldKey = document.createElement('strong');
                                boldKey.innerText = key + ': ';

                                // Append key-value pair to the paragraph
                                paragraph.appendChild(boldKey);
                                paragraph.appendChild(document.createTextNode(item[key]));

                                // Append the paragraph to the result container
                                div.appendChild(paragraph);
                            }
                        });

                        // Add a button for exploring location
                        var exploreButton = document.createElement('button');
                        exploreButton.innerText = 'Go here';
                        exploreButton.classList.add('explore-button');

                        // Set the location ID as a data attribute
                        exploreButton.setAttribute('data-id', item.id);
                        exploreButton.setAttribute('data-explore-type', item.explore_type)

                        exploreButton.addEventListener('click', function() {
                            // Handle button click
                            var locationId = this.getAttribute('data-id');
                            var locationType = this.getAttribute('data-explore_type');
                            exploreLocation(locationId);
                            displayLocationUpdate('climate-updates-container', token);
                        });

                        // Append the explore button to the div
                        div.appendChild(exploreButton);

                        // Append the div to the result container
                        resultContainer.appendChild(div);
                    });
                } else {
                    var div = document.createElement('div');
                    div.classList.add('result');
                    div.innerText = JSON.stringify(data);
                    resultContainer.appendChild(div);
                }
            } else {
                // If data is not an object or an array, display as JSON string
                var div = document.createElement('div');
                div.classList.add('result');
                div.innerText = JSON.stringify(data);
                resultContainer.appendChild(div);
            }
        }

        // Function to recursively format nested objects
        function formatNestedObject(parentElement, obj) {
            Object.keys(obj).forEach(key => {
                var paragraph = document.createElement('p');
                var boldKey = document.createElement('strong');
                boldKey.innerText = key + ': ';
                paragraph.appendChild(boldKey);

                if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                    formatNestedObject(paragraph, obj[key]);
                } else {
                    // Check for null values
                    if (obj[key] === null) {
                        paragraph.appendChild(document.createTextNode("empty"));
                    } else {
                        paragraph.appendChild(document.createTextNode(obj[key]));
                    }
                }

                parentElement.appendChild(paragraph);
            });
        }


        function showMapContainer() {
            document.getElementById('map-container').style.display = 'block';
        }

        function hideMapContainer() {
            document.getElementById('map-container').style.display = 'none';
        }


       // JavaScript code to handle form submission
        document.getElementById('addressForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission

            // Display the loading spinner

                    // local:
       // var token = "0f27cbcf2998d5141a52ef68caa315f187d2437f";
        // Digital Ocean
           // var token = "f38e6b71380f11f62071126b0ff43fc0a2689982";
            displayLoading('climate-updates-container', token); 
 
            showMapContainer();

            displayMapAnimation('map-container');


            // Get the address value from the form
            var address = document.getElementById('address').value;

            // Prepare the data to be sent
            var data = {
                address: address
            };

            // Make a POST request to the endpoint
            fetch(endpoint + 'go/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Token ' + token // Include the user token in the Authorization header
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                // Display the result
                // displayResult('result', data);
            })
            .catch(error => {
                // Display error if any
                document.getElementById('result').innerText = 'Error: ' + error.message;
            });
        });


        // Function to create and display the popup menu dynamically

        function createPopupMenu(itemKey) {
            // Create a div for the popup menu
            var popupMenu = document.createElement('div');
            popupMenu.classList.add('popup-menu');

            // Create a form element
            var form = document.createElement('form');
            form.id = 'popupForm';

            // Create input fields for each required field
            var itemInput = document.createElement('input');
            itemInput.type = 'hidden'; // Hidden input for the associated item key
            itemInput.name = 'item';
            itemInput.value = itemKey;
            form.appendChild(itemInput);

            var descriptorInput = document.createElement('input');
            descriptorInput.type = 'text';
            descriptorInput.name = 'descriptor';
            descriptorInput.placeholder = 'Descriptor';
            descriptorInput.focus();
            form.appendChild(descriptorInput);

            var descriptionInput = document.createElement('input');
            descriptionInput.type = 'text';
            descriptionInput.name = 'description';
            descriptionInput.placeholder = 'Description';
            form.appendChild(descriptionInput);

            var thirdDataInput = document.createElement('input');
            thirdDataInput.type = 'text';
            thirdDataInput.name = 'third_data';
            thirdDataInput.placeholder = 'Third Data';
            form.appendChild(thirdDataInput);

            var submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.innerText = 'Submit';
            form.appendChild(submitButton);

            // Event listener for form submission
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission

                // Gather data from form fields
                var formData = new FormData(form);

                // Prepare the data to be sent
                var data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                // Make a POST request to the endpoint
                fetch(endpoint + 'collect/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Token ' + token // Include the user token in the Authorization header
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    // Handle the response as needed
                    console.log('Collect response:', data);
                    // Optionally, close the popup menu after successful submission
                    popupMenu.remove();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });

            // Append the form to the popup menu
            popupMenu.appendChild(form);

            // Append the popup menu to the body
            document.body.appendChild(popupMenu);
        }


        // Event listener for "Get Item Choices" button
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener to all treasure buttons
            var treasureButtons = document.querySelectorAll('.treasure-button');
            treasureButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Handle treasure button click
                    var itemKey = this.dataset.itemKey;
                    // Create and display the popup menu with the associated item key
                    createPopupMenu(itemKey);
                });
            });

                        // Event listener for close button
            document.getElementById('popupCloseBtn').addEventListener('click', function() {
                // Hide the popup menu when close button is clicked
                document.getElementById('popupMenu').style.display = 'none';
            });
        });

        // Function to create and display the popup menu dynamically
        function createPopupMenu(itemKey) {
            // Show the popup menu
            document.getElementById('popupMenu').style.display = 'block';

            // Populate hidden input field with item key
            document.getElementById('itemInput').value = itemKey;

            // Handle form submission for the popup menu
            document.getElementById('popupForm').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission

                // Gather data from form fields
                var formData = new FormData(this);

                // Prepare the data to be sent
                var data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                // Make a POST request to the endpoint
                fetch(endpoint + 'collect/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Token ' + token // Include the user token in the Authorization header
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    // Handle the response as needed
                    console.log('Collect response:', data);
                    // Optionally, hide the popup menu after successful submission
                    document.getElementById('popupMenu').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        }


        // Function to make GET request to friends endpoint and display popup/modal for treasures
        function getFriendsAndDisplayTreasurePopup(treasureId) { // Updated parameter
            //var url = 'http://127.0.0.1:8000/users/friends/';
             var url = 'https://climatetwin-lzyyd.ondigitalocean.app/users/friends/';
            makeGetRequest(url, function(data) {
                // Display popup/modal with friends as radio buttons for treasures
                displayTreasureFriendsPopup(data, treasureId); // Updated function call
            });
        }
 
        function displayTreasureFriendsPopup(friends, treasureId) { 
            var popupContainer = document.getElementById('giftTreasurePopup');
 
            popupContainer.style.display = 'block';

            // Set the treasure ID in the form input
            var treasureIdInput = document.getElementById('treasureIdInput');
            treasureIdInput.value = treasureId;

            var friendsRadioContainer = document.getElementById('giftFriendsRadio');
            friendsRadioContainer.innerHTML = '';
            friendsRadioContainer.focus();

            // Create radio buttons for each friend and append them to the container
            friends.forEach(friend => {
                var radioButton = document.createElement('input');
                var radioLabel = document.createElement('label');
                radioButton.type = 'radio';
                radioButton.name = 'giftFriend';
                radioButton.value = friend.friend; // Assuming friend object has an 'id' property

                // Append the radio button to the label
                radioLabel.appendChild(radioButton);
                // Add the label text
                radioLabel.appendChild(document.createTextNode(friend.nickname));

                // Add CSS class to label for styling
                radioLabel.classList.add('radio-label');

                // Append the label with the radio button to the container
                friendsRadioContainer.appendChild(radioLabel);

                // Append a line break after each label-radio button pair
                friendsRadioContainer.appendChild(document.createElement('br'));
            });
            // Set focus to the message input field
            var messageInput = document.getElementById('messageInput');


            // Attach form submission handler to the form
            document.getElementById('popupGiftForm').addEventListener('submit', handleFormSubmission);
        }

        // Function to handle form submission
        function handleFormSubmission(event) {
            event.preventDefault(); // Prevent the default form submission

            // Get form data
            var formData = new FormData(event.target);

            // Extract data from form
            var selectedFriendId = formData.get('giftFriend');
            var message = formData.get('message');
            var treasureId = formData.get('treasureId');

            // Send gift
            sendGift(selectedFriendId, message, treasureId);

            // Hide the popup after sending the gift
            var popupContainer = document.getElementById('giftTreasurePopup');
            popupContainer.style.display = 'none';
        }


        // Function to send a gift request
        function sendGift(selectedFriendId, message, treasureId) {
            // Log a message indicating that the function is called
            console.log('Sending gift...');

            // Construct the data object with the required keys and values
            var data = {
                message: message,
                treasure: treasureId,
                recipient: selectedFriendId
            };

            // Make the POST request to the server endpoint with the data in the request body
            fetch(userEndpoint + 'send-gift-request/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Token ' + token
                },
                body: JSON.stringify(data) // Convert the data object to a JSON string
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Handle the response data
                console.log(data);
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }



        // Wrap the event listener setup inside the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Event listener for "View Treasures" button
            document.getElementById('viewTreasuresBtn').addEventListener('click', function() {
                var url = userEndpoint + 'treasures/';
                makeGetRequest(url, function(data) {
                    // Display the result using custom formatting function
                    formatTreasures(data);
                });
                updateButtonText('viewTreasuresBtn', url);
                if (previousButtonId && previousButtonId !== 'viewTreasuresBtn') {
                    document.getElementById(previousButtonId).innerText = previousButtonId;
                }
                previousButtonId = 'viewTreasuresBtn';
            });



            // Event listener for the close button in the gift popup menu
            document.getElementById('popupGiftCloseBtn').addEventListener('click', function() {
                var popupContainer = document.getElementById('giftTreasurePopup');
                popupContainer.style.display = 'none'; // Hide the popup menu
            });

            // Event listener for dynamically created "Gift" buttons using event delegation
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('gift-button')) {
                    var treasureId = event.target.getAttribute('data-treasure-id');
                    getFriendsAndDisplayTreasurePopup(treasureId);
                }
            });
        });








        // Event listener for "User Profile" button
        document.getElementById('userProfileBtn').addEventListener('click', function() {
            //var url = 'http://127.0.0.1:8000/users/profile/';
            var url = 'https://climatetwin-lzyyd.ondigitalocean.app/users/profile/';
            makeGetRequest(url, function(data) {
                // Display the result
                displayResultEdit('result', data);
            });
        });

        // Event listener for "User Inbox" button
        document.getElementById('userInboxBtn').addEventListener('click', function() {
            // var url = 'http://127.0.0.1:8000/users/inbox/items/';
             var url = 'https://climatetwin-lzyyd.ondigitalocean.app/users/inbox/items/';
            makeGetRequest(url, function(data) {
                // Display the result
                displayResultBottom('result', data);
            });
        });


                // Event listener for "Friend Profile" button
        document.getElementById('userFriendProfilesBtn').addEventListener('click', function() {
            // var url = 'http://127.0.0.1:8000/climatevisitor/users/friends/';
             var url = 'https://climatetwin-lzyyd.ondigitalocean.app/users/friends/';
            makeGetRequest(url, function(data) {
                // Display the result
                displayResultEdit('result', data);
            });
        });

        // Event listener for "User Summary" button
        document.getElementById('userSummaryBtn').addEventListener('click', function() {
            // var url = 'http://127.0.0.1:8000/users/summary';
             var url = 'https://climatetwin-lzyyd.ondigitalocean.app/users/summary';
            makeGetRequest(url, function(data) {
                // Display the result
                displayResultSummary('result', data);
            });
        });


        function displayResultSummary(resultContainerId, data) {
            var resultContainer = document.getElementById(resultContainerId);
            resultContainer.innerHTML = ''; // Clear previous results

            // Check if data is an array
            if (Array.isArray(data)) {
                data.forEach(user => {
                    // Create a div for each user
                    var userDiv = document.createElement('div');

                    // Iterate through each key-value pair in the user object
                    Object.keys(user).forEach(key => {
                        var paragraph = document.createElement('p');
                        paragraph.innerHTML = `<strong>${key}:</strong> ${formatValue(user[key])}`;
                        paragraph.className = 'summary-text-container';
                        userDiv.appendChild(paragraph);
                    });

                    // Append the user div to the result container
                    resultContainer.appendChild(userDiv);
                });
            }
        }

        function formatValue(value) {
            // If value is an array, format each item in the array
            if (Array.isArray(value)) {
                return value.map(item => {
                    return formatValue(item);
                }).join('<br>');
            }
            // If value is an object, format its properties
            else if (typeof value === 'object' && value !== null) {
                return Object.keys(value).map(key => {
                    return `<strong>${key}:</strong> ${formatValue(value[key])}`;
                }).join('<br>');
            }
            // If value is a date, format it accordingly
            else if (value instanceof Date) {
                return value.toLocaleString();
            }
            // Otherwise, return the value as is
            else {
                return value;
            }
        }


        function formatValue(value) {
            // If value is an array, format each item in the array
            if (Array.isArray(value)) {
                return value.map(item => {
                    return formatValue(item);
                }).join('<br>');
            }
            // If value is an object, format its properties
            else if (typeof value === 'object' && value !== null) {
                return Object.keys(value).map(key => {
                    return `<strong>${key}:</strong> ${formatValue(value[key])}`;
                }).join('<br>');
            }
            // If value is a date, format it accordingly
            else if (value instanceof Date) {
                return value.toLocaleString();
            }
            // Otherwise, return the value as is
            else {
                return value;
            }
        }

        function displayResultPerformance(resultContainerId, data) {
            var resultContainer = document.getElementById(resultContainerId);
            resultContainer.innerHTML = ''; // Clear previous results

            // Check if data is a string, then parse it to JSON
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (error) {
                    console.error('Error parsing JSON data:', error);
                    return;
                }
            }
 
            function formatValue(value) {
                if (typeof value === 'string') { 
                    return value;
                } else if (value instanceof Date) { 
                    return value.toISOString(); 
                } else { 
                    return value;
                }
            }
 
            if (data && Array.isArray(data.detail)) {
                data.detail.forEach(detail => { 
                    var detailDiv = document.createElement('div');
                    detailDiv.style.border = '1px solid rgba(0, 0, 0, 0.2)';  
                    detailDiv.style.padding = '10px'; 
                    detailDiv.classList.add('result');
 
                    Object.keys(detail).forEach(key => {
                        var paragraph = document.createElement('p');
                        paragraph.innerHTML = `<strong>${key.replace(/_/g, ' ')}:</strong> ${formatValue(detail[key])}`;
                        detailDiv.appendChild(paragraph);
                    });

                    // Append the detail div to the result container
                    resultContainer.appendChild(detailDiv);
                });
            }
        }



        // Function to display result in the specified result container (for the second display box)
        function displayResultBottom(resultContainerId, data) {
            var resultContainer = document.getElementById(resultContainerId);
            resultContainer.innerHTML = ''; // Clear previous results

            // Check if data is an array
            if (Array.isArray(data)) {
                data.forEach(item => {
                    // Create a div for each item in the array
                    var itemDiv = document.createElement('div');
                    itemDiv.classList.add('result-bottom');

                    // Check if the item is an object
                    if (typeof item === 'object' && !Array.isArray(item)) {
                        Object.keys(item).forEach(key => {
                            var paragraph = document.createElement('p');
                            paragraph.innerHTML = `<strong>${key}:</strong> ${item[key]}`;
                            itemDiv.appendChild(paragraph);
                        });

                        // Create "Open" button
                        var openButton = document.createElement('button');
                        openButton.innerText = 'Open';
                        openButton.classList.add('open-message-button');
                        openButton.dataset.itemId = item.id;

                        // Add event listener to handle button click
                        openButton.addEventListener('click', function() {
                            // Toggle between "Open" and "Close"
                            if (this.innerText === 'Open') {
                                openInboxItem(this.dataset.itemId, this.parentElement);
                                this.innerText = 'Close';
                            } else {
                                // closeInboxItem() query selects the open button in order to close it and then changes the text of the button itself, as well as this.innerText
                                closeInboxItem();
                                this.innerText = 'Open';
                            }
                        });

                        // Append the button to the item div
                        itemDiv.appendChild(openButton);
                    } else {
                        itemDiv.innerText = item;
                    }


                    resultContainer.appendChild(itemDiv);
                });
            } else {
                // If data is not an array, check if it's a single object
                if (typeof data === 'object' && !Array.isArray(data)) {
                    // Create a div for the single object
                    var div = document.createElement('div');
                    div.classList.add('result-bottom');

                    // Display each key-value pair
                    Object.keys(data).forEach(key => {
                        var paragraph = document.createElement('p');
                        paragraph.innerHTML = `<strong>${key}:</strong> ${data[key]}`;
                        div.appendChild(paragraph);
                    });

                    var editButton = document.createElement('button');
                    editButton.innerText = 'Edit';

                    editButton.addEventListener('click', function() {
                        editObject(data);
                    });

                    div.appendChild(editButton);
                    resultContainer.appendChild(div);

                } else {
                    var div = document.createElement('div');
                    div.classList.add('result-bottom');
                    div.innerText = JSON.stringify(data);
                    resultContainer.appendChild(div);
                }
            }
        }


        function openInboxItem(itemId, parentElement) {
            if (document.querySelector('.inbox-item-open')) {
                alert('Please close the currently open inbox item before opening another one.');
                return; 
            }

           // var url = 'http://127.0.0.1:8000/users/inbox/item/' + itemId;
             var url = 'https://climatetwin-lzyyd.ondigitalocean.app/users/inbox/item/' + itemId;
            makeGetRequest(url, function(data) {
                var inboxItemDiv = document.createElement('div');
                inboxItemDiv.classList.add('result-bottom');
                inboxItemDiv.classList.add('inbox-item-open'); // Add a class to indicate that the item is open


                /* Added close button function to the open button instead

                var closeButton = document.createElement('button');
                closeButton.innerText = 'Close';
                closeButton.addEventListener('click', function() {
                    // Remove the inbox item when the close button is clicked
                    inboxItemDiv.remove();
                    // Remove the class indicating that an item is open
                    document.querySelector('.inbox-item-open').classList.remove('inbox-item-open');
                });
                */

                if (data.message.content_object.special_type === 'friend request' ||
                    data.message.content_object.special_type === 'gift request') {
                    var acceptButton = document.createElement('button');
                    acceptButton.classList.add('accept-request-button');
                    acceptButton.innerText = 'Accept';
                    acceptButton.addEventListener('click', function() {
                        handleRequest(data.message.content_object.id, true);
                    });

                    var rejectButton = document.createElement('button');
                    rejectButton.classList.add('reject-request-button');
                    rejectButton.innerText = 'Reject';
                    rejectButton.addEventListener('click', function() {
                        handleRequest(data.message.content_object.id, false);
                    });


                }

                var jsonDataDiv = document.createElement('div');
                jsonDataDiv.classList.add('json-data');

                var itemHeader = '';
                if (data.message.content_object.special_type == 'friend request') {
                    itemHeader = 'Friend Request';
                } else if (data.message.content_object.special_type == 'gift request') {
                    itemHeader = 'Gift Request';
                } else {
                    itemHeader = 'Message';
                }

                var header = document.createElement('h2');
                header.innerText = itemHeader;
                inboxItemDiv.appendChild(header);

                var requestButtonsContainer = document.createElement('request-buttons-container')

                    requestButtonsContainer.appendChild(acceptButton);
                    requestButtonsContainer.appendChild(rejectButton);

                    inboxItemDiv.appendChild(requestButtonsContainer);

                Object.keys(data).forEach(key => {
                    var paragraph = document.createElement('p');
                    var boldKey = document.createElement('strong');
                    boldKey.innerText = key + ': ';
                    paragraph.appendChild(boldKey);

                    if (typeof data[key] === 'object') {
                        // Format nested object recursively
                        formatNestedObjectBottom(paragraph, data[key]);
                    } else {
                        paragraph.appendChild(document.createTextNode(data[key]));
                    }

                    jsonDataDiv.appendChild(paragraph);
                });

                inboxItemDiv.appendChild(jsonDataDiv);
                
                /* See notes above
                inboxItemDiv.appendChild(closeButton);
                */

                parentElement.parentNode.insertBefore(inboxItemDiv, parentElement.nextSibling);
            });
        }

        function closeInboxItem() {
            var openItem = document.querySelector('.inbox-item-open');
            
            if (openItem) {
                openItem.remove();
                
                var openButton = document.querySelector('.open-message-button');
                if (openButton) {
                    openButton.innerText = 'Open';
                }
            }
        }



        // Function to handle accepting/rejecting a request
        function handleRequest(itemId, isAccepted) {
           // var url = `http://127.0.0.1:8000/users/inbox/accept-gift-request/${itemId}/`;
             var url = `https://climatetwin-lzyyd.ondigitalocean.app/users/inbox/accept-gift-request/${itemId}/`;
            var requestData = {
                is_accepted: isAccepted,
                is_rejected: !isAccepted
            };


            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Token ' + token
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Handle success response
                console.log('Request handled successfully:', data);
            })
            .catch(error => {
                // Handle error
                console.error('Error handling request:', error);
            });
        }


        function formatNestedObjectBottom(parentElement, obj) {
            Object.keys(obj).forEach(key => {
                var paragraph = document.createElement('p');
                var boldKey = document.createElement('strong');
                boldKey.innerText = key + ': ';
                paragraph.appendChild(boldKey);

                if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                    // If the value is an object, format it recursively
                    formatNestedObjectBottom(paragraph, obj[key]);
                } else {
                    // Append the value to the paragraph
                    paragraph.appendChild(document.createTextNode(obj[key]));
                }

                parentElement.appendChild(paragraph);
            });
        }


        function displayResultEdit(resultContainerId, data) {
            var resultContainer = document.getElementById(resultContainerId);
            resultContainer.innerHTML = ''; // Clear previous results

            // Check if data is an array
            if (Array.isArray(data)) {
                data.forEach(item => {
                    // Create a div for each item in the array
                    var itemDiv = document.createElement('div');
                    itemDiv.classList.add('result-bottom');
                    

                    // Check if the item is an object
                    if (typeof item === 'object' && !Array.isArray(item)) {
                        Object.keys(item).forEach(key => {
                            var paragraph = document.createElement('p');
                            paragraph.innerHTML = `<strong>${key}:</strong> ${item[key]}`;
                            itemDiv.appendChild(paragraph);
                        });
                    } else {
                        itemDiv.innerText = item;
                    }

                    // Create "Edit" button for every item
                    var editButton = document.createElement('button');
                    editButton.innerText = 'Edit';

                    // Add event listener to handle button click
                    editButton.addEventListener('click', function() {
                        editObject(item);
                    });

                    // Append the "Edit" button to the item div
                    //itemDiv.appendChild(editButton);

                    resultContainer.appendChild(itemDiv);
                });
            } else {
                // If data is not an array, treat it as a single item and display accordingly
                var div = document.createElement('div');
                div.classList.add('result-bottom');

                // Display each key-value pair
                Object.keys(data).forEach(key => {
                    var paragraph = document.createElement('p');
                    paragraph.innerHTML = `<strong>${key}:</strong> ${data[key]}`;
                    div.appendChild(paragraph);
                });

                // Create "Edit" button for the single item
                var editButton = document.createElement('button');
                editButton.innerText = 'Edit';

                // Add event listener to handle button click
                editButton.addEventListener('click', function() {
                    editObject(data);
                });

                // Append the "Edit" button to the div
                div.appendChild(editButton);

                resultContainer.appendChild(div);
            }
        }

       // Function to update button text based on endpoint
        function updateButtonText(buttonId, endpoint) {
            var button = document.getElementById(buttonId);
            // Store the original text only if it's not already stored
            if (!button.dataset.originalText) {
                button.dataset.originalText = button.innerText;
            }
            button.innerText = endpoint.replace("https://climatetwin-lzyyd.ondigitalocean.app", "");
            // Remove any inline font size set previously
            button.style.fontSize = "";
        }

        // Keep track of the previously clicked button ID
        var previousButtonId = null;


        // Event listener for buttons
        ['userPerfDataBtn', 'itemChoicesBtn', 'homeWeatherBtn', 'currentlyVisitingBtn', 'viewTreasuresBtn', 'currentlyNearbyBtn', 'currentlyExploringBtn', 'userSettingsBtn', 'userProfileBtn', 'userInboxBtn', 'userFriendProfilesBtn', 'userSummaryBtn'].forEach(function(buttonId) {
            var button = document.getElementById(buttonId);
            button.addEventListener('click', function() {
                var originalText = button.dataset.originalText; // Retrieve the original text from the data attribute
                var endpoint = button.innerText;
                updateButtonText(buttonId, endpoint);
                // Revert text of previous button, if any
                if (previousButtonId && previousButtonId !== buttonId) {
                    document.getElementById(previousButtonId).innerText = document.getElementById(previousButtonId).dataset.originalText;
                }
                previousButtonId = buttonId;
            });
        });





        // Event listener for "User Profile" button
        document.getElementById('userProfileBtn').addEventListener('click', function() {
            var endpoint = 'http://127.0.0.1:8000/users/profile/';
            // var endpoint = 'https://climatetwin-lzyyd.ondigitalocean.app/users/profile/';
            updateButtonText('userProfileBtn', endpoint);
            // Revert text of previous button, if any
            if (previousButtonId && previousButtonId !== 'userProfileBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'userProfileBtn';
        });

        // Event listener for "User Inbox" button
        document.getElementById('userInboxBtn').addEventListener('click', function() {
            var endpoint = 'http://127.0.0.1:8000/users/inbox/items/';
            // var endpoint = 'https://climatetwin-lzyyd.ondigitalocean.app/users/inbox/items/';
            updateButtonText('userInboxBtn', endpoint);
            // Revert text of previous button, if any
            if (previousButtonId && previousButtonId !== 'userInboxBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'userInboxBtn';
        });

        // Event listener for "Friend Profile" button
        document.getElementById('userFriendProfilesBtn').addEventListener('click', function() {
            var endpoint = 'http://127.0.0.1:8000/users/friends/';
            // var endpoint = 'https://climatetwin-lzyyd.ondigitalocean.app/users/friends/';
            updateButtonText('userFriendProfilesBtn', endpoint);
            // Revert text of previous button, if any
            if (previousButtonId && previousButtonId !== 'userFriendProfilesBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'userFriendProfilesBtn';
        });

        // Event listener for "User Summary" button
        document.getElementById('userSummaryBtn').addEventListener('click', function() {
            var endpoint = 'http://127.0.0.1:8000/users/summary/';
            // var endpoint = 'https://climatetwin-lzyyd.ondigitalocean.app/users/summary/';
            updateButtonText('userSummaryBtn', endpoint);
            // Revert text of previous button, if any
            if (previousButtonId && previousButtonId !== 'userSummaryBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'userSummaryBtn';
        });

                // Event listener for "Settings" button
        document.getElementById('userSettingsBtn').addEventListener('click', function() {
           // var url = 'http://127.0.0.1:8000/users/settings/';
             var url = 'https://climatetwin-lzyyd.ondigitalocean.app/users/settings/';
            makeGetRequest(url, function(data) {
                // Display the result
                displayResultEdit('result', data);
            });
            updateButtonText('userSettingsBtn', url);
            if (previousButtonId && previousButtonId !== 'userSettingsBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'userSettingsBtn';
        });

        document.getElementById('currentlyExploringBtn').addEventListener('click', function() {
            var url = endpoint + 'currently-exploring/';
            makeGetRequest(url, function(data) {
                displayResult('result', data);
            });
            updateButtonText('currentlyExploringBtn', url);
            if (previousButtonId && previousButtonId !== 'currentlyExploringBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'currentlyExploringBtn';
        });

        
        document.getElementById('currentlyNearbyBtn').addEventListener('click', function() {
            var url = endpoint + 'currently-nearby/';
            makeGetRequest(url, function(data) {
                displayResult('result', data);
            });
            updateButtonText('currentlyNearbyBtn', url);
            if (previousButtonId && previousButtonId !== 'currentlyNearbyBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'currentlyNearbyBtn';
        });


        document.getElementById('currentlyVisitingBtn').addEventListener('click', function() {
            var url = endpoint + 'currently-visiting/';
            makeGetRequest(url, function(data) {
                displayResult('result', data);
            });
            updateButtonText('currentlyVisitingBtn', url);
            if (previousButtonId && previousButtonId !== 'currentlyVisitingBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'currentlyVisitingBtn';
        });


        // Event listener for "Home Weather" button
        document.getElementById('homeWeatherBtn').addEventListener('click', function() {
            var url = endpoint + 'launchpad-data/';
            makeGetRequest(url, function(data) {
                displayResult('result', data);
            });
            updateButtonText('homeWeatherBtn', url);
            if (previousButtonId && previousButtonId !== 'homeWeatherBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'homeWeatherBtn';
        });



        // Event listener for "Get Item Choices" button
        document.getElementById('itemChoicesBtn').addEventListener('click', function() {
            var url = endpoint + 'item-choices/';
            makeGetRequest(url, function(data) {
                if ('detail' in data) {
                    displayResult('result', { error: data.detail });
                } else {
                    displayResult('result', data);

                    var resultContainer = document.getElementById('result');
                    resultContainer.innerHTML = '';

                    if ('choices' in data) {
                        var choices = data.choices;

                        // Create a div for box-result container
                        var boxResultContainer = document.createElement('div');
                        boxResultContainer.classList.add('box-result');

                        Object.keys(choices).forEach(key => {
                            // Create a div for each key
                            var keyDiv = document.createElement('div');
                            keyDiv.classList.add('square-container'); // Add 'square-container' class

                            // Create a paragraph for the key-value pair
                            var keyParagraph = document.createElement('p');
                            keyParagraph.classList.add('item-choice-key');

                                // Replace underscores with non-breaking spaces for wrapping
                            var formattedKey = key.replace(/_/g, " ");
                            keyParagraph.innerHTML = `<strong>${formattedKey}:</strong>`;

                            // keyParagraph.innerHTML = `<strong>${key}:</strong>`;

                            // Append the key paragraph to the key div
                            keyDiv.appendChild(keyParagraph);

                            var treasureButton = document.createElement('button');
                            treasureButton.classList.add('treasure-button'); 

                            // Create a treasure button for each key
                            if (formattedKey === "explore location  street view image") {
                                // Create an img element for the image
                                var imgElement = document.createElement('img');

                                // Check if the key has a value
                                if (choices[key]) {
                                    // If the key has a value, set the src attribute of the img element to the link value
                                    imgElement.src = choices[key];
                                    
                                    // Set alt text for accessibility
                                    imgElement.alt = "Image Link"; // You can set this to whatever alt text you prefer
                                    
                                    // Apply CSS styles to make the image responsive
                                    imgElement.style.width = '100%';
                                    imgElement.style.height = '100%';
                                    imgElement.style.objectFit = 'cover';
                                    
                                    // Append the image element to the treasure button
                                    treasureButton.style.margin = '0';
                                    treasureButton.style.padding = '0';     
                                    treasureButton.appendChild(imgElement);
                                } else {
                                    // If the key has no value, set the text of the button to "No Image"
                                    treasureButton.innerText = "No Image";
                                }
                            } else {
                                // If the key is not "explore location street view image", set the text of the button to the value
                                treasureButton.innerText = `${choices[key]}`;
                            }

                            

                            // Add a data attribute to store the key
                            treasureButton.dataset.itemKey = key;

                            // Append the treasure button to the key div
                            keyDiv.appendChild(treasureButton);

                            // Append the key div to the box-result container
                            boxResultContainer.appendChild(keyDiv);
                        });

                        // Append the box-result container to the result container
                        resultContainer.appendChild(boxResultContainer);

                        // Add event listeners for treasure buttons
                        var treasureButtons = document.querySelectorAll('.treasure-button');
                        treasureButtons.forEach(button => {
                            button.addEventListener('click', function() {
                                // Handle treasure button click
                                var itemKey = this.dataset.itemKey;
                                // Create and display the popup menu with the associated item key
                                createPopupMenu(itemKey);
                            });
                        });
                    }
                }
            });


                    /*
                    if ('choices' in data) {
                        var choices = data.choices;

                        Object.keys(choices).forEach(key => {
                            // Create a div for each key
                            var keyDiv = document.createElement('div');
                            keyDiv.classList.add('box-result', 'square-container');

                            // Create a paragraph for the key-value pair
                            var keyParagraph = document.createElement('p');
                            keyParagraph.innerHTML = `<strong>${key}:</strong> ${choices[key]}`;

                            // Append the key paragraph to the key div
                            keyDiv.appendChild(keyParagraph);

                            // Create a treasure button for each key
                            var treasureButton = document.createElement('button');
                            treasureButton.innerText = 'Get Treasure';
                            treasureButton.classList.add('treasure-button');

                            // Add a data attribute to store the key
                            treasureButton.dataset.itemKey = key;

                            // Append the treasure button to the key div
                            keyDiv.appendChild(treasureButton);

                            // Append the key div to the result container
                            resultContainer.appendChild(keyDiv);
                        });
                        

                        // Add event listeners for treasure buttons
                        var treasureButtons = document.querySelectorAll('.treasure-button');
                        treasureButtons.forEach(button => {
                            button.addEventListener('click', function() {
                                // Handle treasure button click
                                var itemKey = this.dataset.itemKey;
                                // Create and display the popup menu with the associated item key
                                createPopupMenu(itemKey);
                            });
                        });
                    }
                    */
                
            updateButtonText('itemChoicesBtn', url);
            if (previousButtonId && previousButtonId !== 'itemChoicesBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'itemChoicesBtn';
        });

                // Event listener for "User Performance Data" button
        document.getElementById('userPerfDataBtn').addEventListener('click', function() {
            //var url = 'http://127.0.0.1:8000/climatevisitor/performance/compare/key-data/';
             var url = 'https://climatetwin-lzyyd.ondigitalocean.app/climatevisitor/performance/compare/key-data/';
            makeGetRequest(url, function(data) {
                // Display the result
                displayResultPerformance('result', data);
            });
            updateButtonText('userPerfDataBtn', url);
            if (previousButtonId && previousButtonId !== 'userPerfDataBtn') {
                document.getElementById(previousButtonId).innerText = previousButtonId;
            }
            previousButtonId = 'userPerfDataBtn';
        });




    </script>
</body>
</html>









